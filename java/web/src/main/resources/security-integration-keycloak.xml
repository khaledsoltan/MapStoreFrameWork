<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:security="http://www.springframework.org/schema/security"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/security 
        http://www.springframework.org/schema/security/spring-security.xsd
        http://www.springframework.org/schema/context 
        http://www.springframework.org/schema/context/spring-context-3.0.xsd">

    <!-- ============================================================================ -->
    <!-- === Keycloak Security Integration for GeoStore API ======================= -->
    <!-- ============================================================================ -->

    <!-- Keycloak Authentication Filter -->
    <bean id="keycloakFilter" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakAuthenticationFilter">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
    </bean>

    <!-- Enhanced Keycloak Configuration -->
    <bean id="keycloakConfig" class="it.geosolutions.geostore.services.rest.security.keycloak.KeyCloakSecurityConfiguration">
        <!-- Token validation settings -->
        <property name="enableTokenIntrospection" value="true"/>
        <property name="enableJWTValidation" value="true"/>
        <property name="enableUserInfoEndpoint" value="true"/>
        
        <!-- User management settings -->
        <property name="autoCreateUsers" value="true"/>
        <property name="updateUserOnLogin" value="true"/>
        <property name="syncUserRoles" value="true"/>
        
        <!-- Security settings -->
        <property name="requireSSL" value="false"/>
        <property name="verifyTokenAudience" value="true"/>
        <property name="tokenClockSkew" value="30"/>
    </bean>

    <!-- Keycloak User Details Service -->
    <bean id="keycloakUserDetailsService" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakUserDetailsService">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="userService" ref="userService"/>
        <property name="userGroupService" ref="userGroupService"/>
    </bean>

    <!-- Keycloak Authentication Provider -->
    <bean id="keycloakAuthenticationProvider" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakAuthenticationProvider">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="userDetailsService" ref="keycloakUserDetailsService"/>
    </bean>

    <!-- Token Validation Service -->
    <bean id="keycloakTokenValidator" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakTokenValidator">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="cacheTokenValidation" value="true"/>
        <property name="cacheTimeoutSeconds" value="300"/>
    </bean>

    <!-- Role Mapping Service -->
    <bean id="keycloakRoleMapper" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakRoleMapper">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="defaultRole" value="USER"/>
        <property name="adminRoles">
            <list>
                <value>admin</value>
                <value>ADMIN</value>
                <value>administrator</value>
            </list>
        </property>
        <property name="userRoles">
            <list>
                <value>user</value>
                <value>USER</value>
                <value>member</value>
            </list>
        </property>
    </bean>

    <!-- Session Management -->
    <bean id="keycloakSessionManager" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakSessionManager">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="sessionTimeout" value="3600"/>
        <property name="enableSessionRefresh" value="true"/>
    </bean>

    <!-- Pre-authentication for Keycloak tokens -->
    <bean id="keycloakPreAuthenticationProvider" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakPreAuthenticationProvider">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="tokenValidator" ref="keycloakTokenValidator"/>
        <property name="userDetailsService" ref="keycloakUserDetailsService"/>
    </bean>

    <!-- CORS Configuration for Keycloak -->
    <bean id="keycloakCorsFilter" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakCorsFilter">
        <property name="allowedOrigins">
            <list>
                <value>http://localhost:8081</value>
                <value>https://gisidgw.geosystems-me.com:5443</value>
            </list>
        </property>
        <property name="allowedMethods">
            <list>
                <value>GET</value>
                <value>POST</value>
                <value>PUT</value>
                <value>DELETE</value>
                <value>OPTIONS</value>
            </list>
        </property>
        <property name="allowedHeaders">
            <list>
                <value>Authorization</value>
                <value>Content-Type</value>
                <value>Accept</value>
                <value>Origin</value>
                <value>X-Requested-With</value>
            </list>
        </property>
        <property name="allowCredentials" value="true"/>
    </bean>

    <!-- Keycloak Error Handler -->
    <bean id="keycloakErrorHandler" class="it.geosolutions.geostore.services.rest.security.keycloak.KeycloakErrorHandler">
        <property name="keycloakConfiguration" ref="keycloakConfig"/>
        <property name="enableDetailedErrors" value="true"/>
    </bean>

</beans> 